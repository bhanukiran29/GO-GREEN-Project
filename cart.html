<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Your Cart</title>
    <!-- Link to your existing CSS (keeps style organized) -->
    <link rel="stylesheet" href="cart.css">

    <!-- Small inline tweaks to ensure green theme compatibility (optional) -->
    <style>
        body { background: #e8f8e4; } /* subtle green background to match checkout */
        .cart-container { margin-top: 40px; }
        .action-btn { padding:10px 16px; border-radius:6px; cursor:pointer; border: none; }
        .btn-buy-all { background:#1b6b3a; color:white; font-weight:600; }
        .btn-remove { background:#d9534f; color:white; }
        .btn-buy-now { background:#1b6b3a; color:white; }
        .qty-btn { padding:6px 10px; border-radius:4px; background:#f0f0f0; border:1px solid #ddd; cursor:pointer; }
    </style>
</head>

<body>
    <div class="cart-page-wrapper cart-container">
        <div class="cart-header">
            <h1>Your Cart</h1>
        </div>

        <div class="cart-content">
            <!-- Items column -->
            <div class="cart-items-list" id="cartItems">
                <!-- JS will render items here -->
            </div>

            <!-- Summary sidebar -->
            <aside class="cart-summary-sidebar">
                <div class="summary-box">
                    <div class="subtotal-text">Order Summary</div>
                    <div style="display:flex;justify-content:space-between;margin-bottom:10px;">
                        <div>Items</div>
                        <div id="summaryCount">0</div>
                    </div>
                    <div style="display:flex;justify-content:space-between;">
                        <div>Total</div>
                        <div class="total-price" id="totalPrice">₹0</div>
                    </div>

                    <div style="margin-top:18px;">
                        <button id="buyAllBtn" class="checkout-button" style="background:#1b6b3a;border: none;color: #fff;"
                                onclick="buyNowAll()">Buy All Now</button>
                    </div>
                </div>

                <div class="promo-box">
                    <p>Green delivery • Secure checkout • Easy returns</p>
                </div>
            </aside>
        </div>
    </div>

<script>
/* CONFIG */
const API_URL = "http://localhost:5002/api";

/* Helpers */
function getUserId() {
    return sessionStorage.getItem("userId");
}

/* Fetch cart from backend */
async function getCart() {
    const userId = getUserId();
    if (!userId) return [];

    try {
        const res = await fetch(`${API_URL}/cart/${userId}`);
        const data = await res.json();
        // backend returns { userId, items: [...] } or similar; adapt accordingly
        return data.items || [];
    } catch (err) {
        console.error("Error fetching cart:", err);
        return [];
    }
}

/* Render cart items */
async function loadCart() {
    const cart = await getCart();
    const container = document.getElementById("cartItems");
    const totalElement = document.getElementById("totalPrice");
    const summaryCount = document.getElementById("summaryCount");

    if (!cart.length) {
        container.innerHTML = `
            <div style="padding:20px;text-align:center;color:#666;">
                Your cart is empty.
            </div>
        `;
        totalElement.textContent = "₹0";
        summaryCount.textContent = "0";
        return;
    }

    let html = "";
    let total = 0;
    let count = 0;

    cart.forEach((item) => {
        const qty = item.qty || 1;
        const subtotal = (item.price || 0) * qty;
        total += subtotal;
        count += qty;

        html += `
            <div class="cart-item">
                <div class="item-image">
                    <img src="${item.img || ''}" alt="${item.name || ''}" style="width:100%;height:100%;object-fit:cover;border-radius:6px;">
                </div>

                <div class="item-details">
                    <h3 class="item-title">${item.name || 'Product'}</h3>
                    <div style="margin:6px 0;color:#444;">₹${item.price}</div>

                    <div class="item-controls" style="margin-top:10px;align-items:center;">
                        <button class="qty-btn" onclick="decreaseQty('${item.productId}')">-</button>
                        <span style="padding:0 10px;">${qty}</span>
                        <button class="qty-btn" onclick="increaseQty('${item.productId}')">+</button>

                        <span style="margin-left:16px;color:#666;">Subtotal: ₹${subtotal}</span>
                    </div>
                </div>

                <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end;">
                    <div class="item-price">₹${subtotal}</div>

                    <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px;">
                        <button class="action-btn btn-buy-now" onclick="buyNowItem('${item.productId}')">Buy Now</button>
                        <button class="action-btn btn-remove" onclick="removeItem('${item.productId}')">Remove</button>
                    </div>
                </div>
            </div>
        `;
    });

    container.innerHTML = html;
    totalElement.textContent = "₹" + total;
    summaryCount.textContent = count;
}

/* Quantity handlers */
async function increaseQty(productId) {
    const cart = await getCart();
    const item = cart.find(i => i.productId === productId);
    if (!item) return;

    const userId = getUserId();
    if (!userId) return;

    try {
        await fetch(`${API_URL}/cart/update`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                userId,
                productId,
                qty: item.qty + 1
            })
        });
        await loadCart();
    } catch (err) {
        console.error("Error updating quantity:", err);
    }
}

async function decreaseQty(productId) {
    const cart = await getCart();
    const item = cart.find(i => i.productId === productId);
    if (!item || item.qty <= 1) return;

    const userId = getUserId();
    if (!userId) return;

    try {
        await fetch(`${API_URL}/cart/update`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                userId,
                productId,
                qty: item.qty - 1
            })
        });
        await loadCart();
    } catch (err) {
        console.error("Error updating quantity:", err);
    }
}

/* Remove single item */
async function removeItem(productId) {
    const userId = getUserId();
    if (!userId) return;

    try {
        await fetch(`${API_URL}/cart/remove`, {
            method: "DELETE",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                userId,
                productId
            })
        });
        await loadCart();
    } catch (err) {
        console.error("Error removing item:", err);
    }
}

/* Buy Now — save only the selected productId (string) */
async function buyNowItem(productId) {
    // Save productId strings only (checkout expects array of ids)
    localStorage.setItem("checkoutItems", JSON.stringify([productId]));
    // Redirect to checkout page
    window.location.href = "checkout.html";
}

/* Buy All — save all productId strings from cart */
async function buyNowAll() {
    const cart = await getCart();

    if (!cart.length) {
        alert("Your cart is empty!");
        return;
    }

    // Map to productId strings (ensure consistent format)
    const productIds = cart.map(item => item.productId);

    localStorage.setItem("checkoutItems", JSON.stringify(productIds));
    window.location.href = "checkout.html";
}

/* When an order is completed, backend currently clears the cart.
   We rely on backend to clear. After returning from checkout-success
   the user sees updated cart when page reloads.
*/

document.addEventListener("DOMContentLoaded", loadCart);
</script>
</body>
</html>
