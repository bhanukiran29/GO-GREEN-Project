<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Your Cart</title>
    <style>
        body {
            background: #dffbe1;
            font-family: Poppins, sans-serif;
        }

        .cart-container {
            width: 70%;
            margin: 50px auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
        }

        .cart-item {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 15px 0;
            border-bottom: 1px solid #ccc;
        }

        .cart-item img {
            width: 120px;
            height: 120px;
            border-radius: 10px;
            object-fit: cover;
        }

        h2 {
            font-size: 30px;
            color: #1b4332;
        }
    </style>
</head>

<body>
    <div class="cart-container">
        <h2>Your Cart</h2>
        <div id="cartItems"></div>

        <h3 id="totalPrice" style="margin-top:20px;">Total: ₹0</h3>
        <div style="margin-top:12px;">
            <button onclick="buyNowAll()"
                style="padding:10px 16px;background:#1b6b3a;color:white;border:none;border-radius:6px;cursor:pointer;font-size:16px;">
                Buy All Now
            </button>
        </div>
    </div>

    <script>
        const API_URL = "http://localhost:5002/api";

        function getUserId() {
            return sessionStorage.getItem("userId");
        }

        async function getCart() {
            const userId = getUserId();
            if (!userId) return [];

            try {
                const res = await fetch(`${API_URL}/cart/${userId}`);
                const data = await res.json();
                return data.items || [];
            } catch (err) {
                console.error("Error fetching cart:", err);
                return [];
            }
        }

        async function loadCart() {
            const cart = await getCart();
            const container = document.getElementById("cartItems");
            const totalElement = document.getElementById("totalPrice");

            if (!cart.length) {
                container.innerHTML = "<p>Your cart is empty.</p>";
                totalElement.textContent = "Total: ₹0";
                return;
            }

            let html = "";
            let total = 0;

            cart.forEach((item) => {
                const subtotal = item.price * (item.qty || 1);
                total += subtotal;

                html += `
        <div class="cart-item" style="display:flex;gap:15px;align-items:center;padding:10px 0;border-bottom:1px solid #ddd;">
            <img src="${item.img}" style="width:90px;height:90px;border-radius:10px;object-fit:cover;">
            <div style="flex:1;">
                <h3 style="margin:0;">${item.name}</h3>
                <p style="margin:5px 0;">₹${item.price}</p>
                <button onclick="decreaseQty('${item.productId}')">-</button>
                <span style="padding:0 10px;">${item.qty || 1}</span>
                <button onclick="increaseQty('${item.productId}')">+</button>
                <p style="margin:5px 0;">Subtotal: ₹${subtotal}</p>
            </div>
            <button onclick="buyNowItem('${item.productId}')"
                style="padding:8px 12px;background:#1b6b3a;color:white;border:none;border-radius:6px;cursor:pointer;">
                Buy Now
            </button>
            <button onclick="removeItem('${item.productId}')"
                style="padding:8px 12px;background:red;color:white;border:none;border-radius:6px;cursor:pointer;">
                Remove
            </button>
        </div>
        `;
            });

            container.innerHTML = html;
            totalElement.textContent = "Total: ₹" + total;
        }

        async function increaseQty(productId) {
            const cart = await getCart();
            const item = cart.find(i => i.productId === productId);
            if (!item) return;

            const userId = getUserId();
            if (!userId) return;

            try {
                await fetch(`${API_URL}/cart/update`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        userId,
                        productId,
                        qty: item.qty + 1
                    })
                });
                loadCart();
            } catch (err) {
                console.error("Error updating quantity:", err);
            }
        }

        async function decreaseQty(productId) {
            const cart = await getCart();
            const item = cart.find(i => i.productId === productId);
            if (!item || item.qty <= 1) return;

            const userId = getUserId();
            if (!userId) return;

            try {
                await fetch(`${API_URL}/cart/update`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        userId,
                        productId,
                        qty: item.qty - 1
                    })
                });
                loadCart();
            } catch (err) {
                console.error("Error updating quantity:", err);
            }
        }

        async function removeItem(productId) {
            const userId = getUserId();
            if (!userId) return;

            try {
                await fetch(`${API_URL}/cart/remove`, {
                    method: "DELETE",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        userId,
                        productId
                    })
                });
                loadCart();
            } catch (err) {
                console.error("Error removing item:", err);
            }
        }

        async function buyNowItem(productId) {
            const cart = await getCart();
            const item = cart.find(i => i.productId === productId);
            if (!item) return;

            localStorage.setItem("checkoutItems", JSON.stringify([item]));
            window.location.href = "checkout.html";
        }

        async function buyNowAll() {
            const cart = await getCart();

            if (!cart.length) {
                alert("Your cart is empty!");
                return;
            }

            localStorage.setItem("checkoutItems", JSON.stringify(cart));
            window.location.href = "checkout.html";
        }

        document.addEventListener("DOMContentLoaded", loadCart);
    </script>
</body>

</html>